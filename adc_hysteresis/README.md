## Моторизированная тележка управляемая по ИК от стандартного пульта ДУ
### Модуль цифровой схемы для контроля гистерезиса (adc_hysteresis)

Данный модуль получает цифровой сигнал с АЦП [ADC128S052](https://static.chipdip.ru/lib/827/DOC031827742.pdf) и сравнивает его с пороговыми значениями для управления датчиком препятствия.
Модуль разработан для платы ["Карно"](https://github.com/Fabmicro-LLC/Karnix_ASB-254/blob/master/Karnix_ASB-254-v1.1/schematics/Karnix_ASB.pdf) на базе Lattice ECP5.

### Запуск на ОС Linux:
1. Установить инструментарий: [YosysHQ](https://github.com/YosysHQ/oss-cad-suite-build/releases/), [OpenFPGALoader](https://github.com/trabucayre/openFPGALoader).
2. Установить make, python: `sudo apt install make python3`
3. В директории adc_capture выполнить `make upload`

### Входные параметры:
* `X_High` - верхнее пороговое значение напряжения с фотодиода, превышение которого приводит к остановке тележки (`can_move_fwd <= 0`);
* `X_Low` - нижнее пороговое значение напряжения с фотодиода. Разрешает движение в прямом направлении, если уровень напряжения меньше (`can_move_fwd <= 1`);

### Входные сигналы:
* `clk` - тактовый сигнал;
* `rst` - сигнал сброса;
* `adc_ready` - сигнал о завершении АЦП его рабочего цикла;
* `d_signal` - цифровой сигнал (12 бит) с АЦП, отражающий напряжение с фотодиода;
* `not_d_signal` - преобразованный цифровой сигнал (12 бит) с АЦП, отфильтрованный с учетом его предыдущего значения.

### Выходные сигналы:
* `can_move_fwd` - сигнал разрешения движения в прямом направлении;
* `adc_ack` - сигнал о завершении обработки цифрового сигнала с АЦП.

### Описание работы:
модуль предназначен для контроля гистерезиса цифрового сигнала и формирование разрешающего сигнала на движение вперед (`can_move_fwd`).
Для решения этих задач задаются пороговые значения напряжения, между которыми разрешающий сигнал не изменяется. 
График работы модуля представлен ниже:

![hysteresis](https://github.com/user-attachments/assets/53f9f4db-4324-47a3-97bb-ebb2db8c06f5)

В случае использованного в тележке фотодиода, его напряжение изменяется в пределах 0.4-2.8 В, поэтому в качестве пороговых значений эмпирическим путем были выбраны 1.3-1.5 В (12'd1059-12'd1246).

### Тестирование модуля:
Для отладки и тестирования модуля предусмотрен файл top.sv, в котором предусмотрена работа с четырьмя кнопками key[3:0] и четырьмя светодиодами led[3:0].
Кнопки позволяют управлять входными сигналами модуля, имитируя работу АЦП, а светодиоды отображают выходные и промежуточные сигналы.

Ниже представлены таблицы, описывающие поведение кнопок и индикации на светодиодах:

| Кнопки `key`       | Действие                                               |
| ------------------ | ------------------------------------------------------ |
| `key[0]`           | Сброс (`rst`)                                          |
| `key[1]`           | Установить сигнал `adc_ready = 1` на следующем такте     |
| `key[3:2] = 2'b00` | Установить `d_signal = 800` (низкий уровень сигнала)   |
| `key[3:2] = 2'b01` | Установить `d_signal = 3200` (высокий уровень сигнала) |
| `key[3:2] = 2'b10` | Установить `d_signal = 2500` (средний уровень 1)       |
| `key[3:2] = 2'b11` | Установить `d_signal = 1500` (средний уровень 2)       |

| Светодиоды `led` | Сигнал             | Описание                                                             |
| ------------------ | ------------------ | -------------------------------------------------------------------- |
| `led[0]`           | `not_d_signal[10]` | 11-й бит отфильтрованного сигнала                                    |
| `led[1]`           | `not_d_signal[11]` | 12-й бит отфильтрованного сигнала                                    |
| `led[2]`           | `can_move_fwd`     | 1 — движение разрешено, 0 — запрещено                                 |
| `led[3]`           | `adc_ack`          | 1 — модуль принял и обработал значение, 0 — ожидание `adc_ready`     |

