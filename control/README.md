## Моторизированная тележка управляемая по ИК от стандартного пульта ДУ
### Модуль цифровой схемы для управления движением тележки (control)

Этот модуль, основываясь на декодированных команд с пульта ДУ, посылает управляющие сигналы на электродвигатель и сервопривод.
Модуль спроектирован для работы на плате ["Карно"](https://github.com/Fabmicro-LLC/Karnix_ASB-254), на базе ПЛИС Lattice ECP5.

### Входные параметры:
* clk_hz - частота тактового сигнала ПЛИС (по умолчанию 25МГц);
* sclk_hz - частота работы модуля (по умолчанию 256 Гц);
* servo_min - минимальный коэффициент заполнения PDM для сервопривода (0-255, соответствует крайнему правому положению колес);
* servo_max - максимальный коэффициент заполнения PDM для сервопривода (0-255, соответствует крайнему левому положению колес);
* servo_step - изменение коэффициента заполнения PDM за одно нажатие кнопки (по умолчанию 32);
* servo_center - центральное положение колес, получается при нажатии кнопки сброса 0 (по умолчанию 155);
* motor_min - минимальный коэффициент заполнения PWM для электродвигателя (0-255, соответствует минимальной скорости);
* motor_max - максимальный коэффициент заполнения PWM для электродвигателя (0-255, соответствует максимальной скорости);
* motor_step - изменения коэффициента заполнения PWM за одно нажатие кнопки (по умолчанию 32).

### Входные сигналы:
* clk - тактовая частота;
* rst - сигнал сброса;
* ir_ready - сигнал готовности модуля IRDecoder передавать данные;
* can_move_fwd - сигнал, сигнализирующий о возможности движения вперед (впереди нет препятствия).
* command (32-bit) - декодированная команда;

### Выходные сигналы:
* state - сигнал, сигнализирующий о состоянии тележки (вкл/выкл);
* ctl_valid - сигнал готовности модуля Control принимать данные;
* ack - сигнал завершения обработки команды;
* direction - сигнал направления движения (1 - вперед, 0 - назад);
* motor_dc (8-bit) - коэффициент заполнения PWM электродвигателя;
* servo_dc (8-bit) - коэффициент заполнения PDM сервопривода.

### Список команд:
Ниже представлен список команд пульта ДУ Samsung, которые обрабатывает модуль:

| Код команды | Кнопка на пульте | Управляющее воздействие                 | Пояснение             |
|-------------|------------------|-----------------------------------------|-----------------------|
|  0xFD020707 | Power OFF/ON (2) |  state <= 0                             |  Выключе              |
|  0xFE010707 | Signal Source    |  state <= 1                             |  Включение            |
|  0xED120707 | Channel +        |  direction <= 1                         |  Прямой ход           |
|  0xEF100707 | Channel -        |  direction <= 0                         |  Задний ход           |
|  0x97680707 | Enter            |  servo_dc <= 8'(servo_center)           |  Выравнивание колес   |
|  0x9A650707 | Left             |  servo_dc <= servo_pdm - 8'(servo_step) |  Поворот налево       |
|  0x9D620707 | Right            |  ervo_dc <= servo_pdm + 8'(servo_step)  |  Поворот направо      |
|  0x9F600707 | Up               |  motor_dc <= motor_dc + 8'(motor_step)  |  Увеличить скорость   |
|  0x9E610707 | Down             |  motor_dc <= motor_dc - 8'(motor_step)  |  Уменьшить скорость   |
|  0x86790707 | Home             |  motor_dc <= 0                          |  Останов              |

### Запуск на ОС Linux:
1. Установить инструментарий: [YosysHQ](https://github.com/YosysHQ/oss-cad-suite-build/releases/), [OpenFPGALoader](https://github.com/trabucayre/openFPGALoader).
2. Установить make, python: `sudo apt install make python3`
3. В директории Control выполнить `make upload`

### Тестирование
Для тестирования модуля в отрыве от остальных предусмотрен файл `top.sv`, позволяющий отследить выполнение основных команд через 4 кнопки и 4 светодиода на плате (key[3:0], led[3:0]).
Ниже представлена таблица команд для тестирования.

#### Таблица команд

| Код команды (key[3:0])| Код команды (command) | Управляющее воздействие |
|------------------------|----------------------|-------------------------|
| 0001                   | 7C83FF00             | Увеличить скорость мотора (motor_dc) |
| 0010                   | 6F90FF00             | Уменьшить скорость мотора (motor_dc) |
| 0011                   | 6A95FF00             | Передний ход (direction <= 1) |
| 0100                   | 659AFF00             | Задний ход (direction <= 0) |
| 0101                   | 649BFF00             | Увеличить значение сервопривода (servo_dc) |
| 0110                   | 6699FF00             | Уменьшить значение сервопривода (servo_dc) |
| 1000                   | 00000000             | Вернуть исходные значения сигналов (rst) |

#### Описание работы светодиодов

- **LED[0]**: Индикатор состояния (state):
  - Включен, если система включена (state = 1).
  - Выключен, если система выключена (state = 0).
  
- **LED[1]**: Индикатор направления (direction):
  - Включен, если направление установлено как "вперед" (direction = 1).
  - Выключен, если направление установлено как "назад" (direction = 0).

- **LED[2]**: Индикатор скорости мотора (motor_dc):
  - Включен, если скорость мотора больше 127 (motor_dc > 127).
  - Выключен, если скорость мотора меньше или равна 127.

- **LED[3]**: Индикатор положения сервопривода (servo_dc):
  - Включен, если значение сервопривода больше 155 (servo_dc > 155).
  - Выключен, если значение сервопривода меньше или равно 155.
